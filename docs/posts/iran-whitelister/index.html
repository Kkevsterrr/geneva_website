<!DOCTYPE html>
<html lang="en-US" color-mode='light'>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Geneva is a genetic algorithm that automatically learns how to evade nation state censors.">
        
        <title>censorship.ai  | Iran: A New Model for Censorship</title>
        <meta name="viewport" content="width=device-width,minimum-scale=1, initial-scale='1.0'">
        <meta name="generator" content="Hugo 0.82.1" />
        
        
        <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
        

        
        
        <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
        

        
        <link rel="stylesheet" href="/css/style.css">
        
        <link rel="stylesheet" href="/css/syntax.css">
        
        <link rel="stylesheet" href="/css/labels.css">
        

        
        
        

        

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" type='text/javascript'></script>
        <script type='text/javascript'>
            $(document).ready(function() {
                let isMobile = window.matchMedia("only screen and (max-width: 760px)").matches;

                if (isMobile) {
                    var viewportHeight = $('.section').outerHeight();
                    $('.section').css({ height: viewportHeight });
                }
            })
        </script>

        <meta property="og:title" content="Iran: A New Model for Censorship" />
<meta property="og:description" content="Ahead of its February 21st elections and amidst the chaos of COVID-19, Iran quietly deployed a second censorship system: a protocol whitelister. Click read more to learn about how the protocol whitelister works and how we can circumvent it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://geneva.cs.umd.edu/posts/iran-whitelister/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-18T09:53:38-05:00" />
<meta property="article:modified_time" content="2020-03-18T09:53:38-05:00" /><meta property="og:site_name" content="censorship.ai" />

<meta itemprop="name" content="Iran: A New Model for Censorship">
<meta itemprop="description" content="Ahead of its February 21st elections and amidst the chaos of COVID-19, Iran quietly deployed a second censorship system: a protocol whitelister. Click read more to learn about how the protocol whitelister works and how we can circumvent it."><meta itemprop="datePublished" content="2020-03-18T09:53:38-05:00" />
<meta itemprop="dateModified" content="2020-03-18T09:53:38-05:00" />
<meta itemprop="wordCount" content="3040">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iran: A New Model for Censorship"/>
<meta name="twitter:description" content="Ahead of its February 21st elections and amidst the chaos of COVID-19, Iran quietly deployed a second censorship system: a protocol whitelister. Click read more to learn about how the protocol whitelister works and how we can circumvent it."/>

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-WM3D2KZ64S"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-WM3D2KZ64S');
        </script>
    </head>

    <body class="ma0 avenir bg-color">

        
   
  



  
  
  <header class="cover bg-top" style="background-image: url('https://geneva.cs.umd.edu/laptop.jpeg');">

    <script src="/particles.js"></script>
    <div class="pb3-m pb6-l bg-black-60" id='particle-container'>
      <nav class="pv3 ph3 ph4-ns" role="navigation">
    <div class="flex-l justify-between items-center center">
        <a href="https://geneva.cs.umd.edu" class="subtext f3 fw2 hover-white no-underline white-90 dib">
            censorship.ai
        </a>
        <div class="flex-l items-center">
            
            <ul class="pl0 mr3">
                
                <li class="list f5 f4-ns fw4 dib pr3">
                    <a class="hover-white no-underline white-90" href="/about/" title="About Geneva page">About</a>
                </li>
                
                <li class="list f5 f4-ns fw4 dib pr3">
                    <a class="hover-white no-underline white-90" href="/people/" title="People page">People</a>
                </li>
                
                <li class="list f5 f4-ns fw4 dib pr3">
                    <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">Posts</a>
                </li>
                
                <li class="list f5 f4-ns fw4 dib pr3">
                    <a class="hover-white no-underline white-90" href="/code/" title="Code &amp; Data page">Code</a>
                </li>
                
                <li class="list f5 f4-ns fw4 dib pr3">
                    <a class="hover-white no-underline white-90" href="/papers/" title="Papers page">Papers</a>
                </li>
                
            </ul>
            



                




            <div class="hideonmobile">
            








<a href="https://github.com/kkevsterrr/geneva" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l" title="Github link" rel="noopener" aria-label="follow on Githubâ€”â€”Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







            </div>

            
            <button class="color-mode__btn light--hidden" aria-label="Toggle light mode">
                <svg aria-hidden="true">
                    <use href="#sun">
                        <svg id="sun" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                    </use>
                </svg>
            </button>

            
            <button class="color-mode__btn dark--hidden" aria-label="Toggle dark mode">
                <svg aria-hidden="true">
                    <use href="#moon">
                        <svg viewBox="0 0 24 24" id="moon">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </use>
                </svg>
            </button>
            <script type='text/javascript'> 
                const toggleColorMode = function(e) {
                    
                    if (e.currentTarget.classList.contains("light--hidden")) {
                        
                        document.documentElement.setAttribute("color-mode", "light");

                        
                        localStorage.setItem("color-mode", "light");
                        return;
                    }
                
                    

                    document.documentElement.setAttribute("color-mode", "dark");

                    
                    localStorage.setItem("color-mode", "dark");
                };

            
            const toggleColorButtons = document.querySelectorAll(".color-mode__btn");

            
            toggleColorButtons.forEach(btn => {
                btn.addEventListener("click", toggleColorMode);
            });

            
            if (
                 
                localStorage.getItem('color-mode') === 'dark' ||
                (window.matchMedia('(prefers-color-scheme: dark)').matches &&
                 !localStorage.getItem('color-mode'))
            ) {
                
                document.documentElement.setAttribute('color-mode', 'dark')
            }
        </script>
        </div>
    </div>
</nav>


      <div class="tc-l pv6 ph3 ph4-ns">
        
          <h1 class="f2 f1-l fw2 white-90 mb0 lh-title" style="font-weight:normal">Iran: A New Model for Censorship</h1>
          
        
      </div>
    </div>
    

  </header>



        <main class="pb7" role="main">
            
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked light-gray">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://geneva.cs.umd.edu/posts/iran-whitelister/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://geneva.cs.umd.edu/posts/iran-whitelister/&amp;text=Iran:%20A%20New%20Model%20for%20Censorship" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://geneva.cs.umd.edu/posts/iran-whitelister/&amp;title=Iran:%20A%20New%20Model%20for%20Censorship" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      
      
      
      <time class="f6 mv4 dib tracked light-gray" datetime="2020-03-18T09:53:38-05:00">March 18, 2020</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy avenir f4 nested-links nested-img light-gray pr4-l"><p><strong>Summary: Ahead of its February 21st elections, Iran subtly deployed a second censorship system: a <em>protocol whitelister.</em></strong></p>
<p>In this article, we will describe the protocol whitelister, how it works, and <strong>how it can be defeated</strong>.</p>
<ul>
<li>The protocol whitelister only allows (&ldquo;whitelists&rdquo;) a small list of protocols to be used, posing a threat to almost all existing censorship-evasion tool deployments (VPNs, Tor, Proxies, etc).</li>
<li>Due to its design, the whitelister is challenging to detect, measure, or study from outside the country.  We present how we performed our measurements, and report on who the whitelister targets and what protocol fingerprints it uses.</li>
<li>We deployed <em>Geneva</em> against the protocol whitelister and have discovered multiple ways to circumvent it. We also identify mistakes Iran made in crafting the fingerprints.</li>
</ul>
<p>As of time of writing, the whitelister is still in effect from all of our vantage points within Iran.</p>
<div class="callout callout-gray" style="">
  <div></div>
	<div class="callout-inner">
<p>All of our experiments were performed across six vantage points in Iran, located in Isfahan, Razavi Khorasan, Fars, Tehran, and Zanjan to machines we controlled in Microsoft Azure, Amazon EC2, and DigitalOcean. While this is representative, it is possible that we are not seeing the full picture; if you would like to help broaden our measurements, please contact us.</p>
  </div>
</div>
<hr>
<h1 id="a-quiet-deployment">A Quiet Deployment</h1>
<p>Around the time of Iran&rsquo;s parliamentary elections, reports began surfacing that Iran was degrading internet traffic crossing its borders.</p>
<div class ="flex-container" style='align-items: start'>
  
<div class="flex-column">
  

<div style="text-align: center;">
    
<div style="display: inline-block; width: 350px">
    

<blockquote class="twitter-tweet"><p lang="fa" dir="rtl">Ø¨Ø§Ø² Ú†Ù‡ Ú†ÛŒ Ú©Ø§Ø± Ú©Ø±Ø¯ÛŒØ¯! Ø§ÛŒÙ†  Ø§ÛŒÙ†ØªØ±Ù†Øª<br>ØªÙˆ Ù‚Ø±Ø·ÛŒÙ†Ù‡ Ù†Ù…ÛŒØ´Ù‡ Ø¯ÙˆØªØ§ ÙÛŒÙ„Ù… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø±Ø¯ ØŸ!<a href="https://twitter.com/azarijahromi?ref_src=twsrc%5Etfw">@azarijahromi</a><br>Ø§ÛŒÙ† Ø³Ø±Ø¹Øª Ø¨Ø§ ÙÙˆÙ„ Ø¢Ù†ØªÙ†LTE Ù‡Ù…Ø±Ø§Ù‡ Ø§ÙˆÙ„ <a href="https://twitter.com/www_mci_ir?ref_src=twsrc%5Etfw">@www_mci_ir</a>  <a href="https://twitter.com/hashtag/%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA?src=hash&amp;ref_src=twsrc%5Etfw">#Ø§ÛŒÙ†ØªØ±Ù†Øª</a> <a href="https://t.co/4nJNBCWEWQ">pic.twitter.com/4nJNBCWEWQ</a></p>&mdash; ÙˆÙØ±Ù†ÙˆØ³ ÙÙØ¯Ø±Ø§Ù†ÛŒğŸ˜·ğŸ’‰ğŸ‡ºğŸ‡¦ (@Fedrani_v) <a href="https://twitter.com/Fedrani_v/status/1233844197276315648?ref_src=twsrc%5Etfw">February 29, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>





</div>


</div>


</div>

<div class="flex-column">
  
<div style="text-align: center;">
    
<div style="display: inline-block; width: 350px">
    
<span style="font-size:0.875em;">
    

<p><em>Content of link to tweet is unavailable or may have been removed by the author.</em></p>
<p>Ø³Ø±Ø¹Øª Ø§ÛŒÙ†ØªØ±Ù†Øª #ÙˆÛŒ_Ù¾ÛŒ_Ø§Ù† #Ø§ÛŒØ±Ø§Ù† #Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ #Ø³Ø±Ø¹Øª #Ø§ÛŒÙ†ØªØ±Ù†Øª #ÙÛŒÙ„ØªØ±Ø´Ú©Ù† #Ù¾Ø±ÙˆÚ©Ø³ÛŒ #eclipsevpn #vpn #iran #internet pic.twitter.com/aplRfTizpb</p>
<p>â€” Kamran M (@MKami823) February 18, 2020</p>




</span>


</div>


</div>


</div>




</div>

<p>However, while internet degradation was taking place, Iran subtly deployed a <strong>secondary censorship system</strong>, a <em>protocol whitelister</em>, which garnered much less attention. The protocol whitelister only affects traffic leaving Iran and is minimally invasive to most non-forbidden traffic, making it harder for researchers to detect.</p>
<hr>
<h1 id="protocol-whitelisting">Protocol Whitelisting</h1>
<p>Iran has extended its censorship infrastructure to include a <em>protocol whitelister</em> at a high level, a protocol whitelister inspects Internet traffic and drops all connections that do not match an allowed fingerprint.</p>
<h2 id="how-irans-protocol-whitelister-works">How Iran&rsquo;s Protocol Whitelister Works</h2>
<p>The whitelister performs deep packet inspection (DPI) on the packet payloads sent by clients in Iran; if the data sent at the start of the connection does not match an allowed protocol fingerprint, the rest of the flow from the client is dropped.</p>
<p>Iran&rsquo;s protocol whitelisting system affects only TCP traffic on port 53, 80, 443, and only to specific IP ranges. The whitelister has fingerprints to match for DNS, HTTP, and HTTPS traffic, but each protocol is not bound to is associated port: the whitelister will match all three protocols on any of the three ports.</p>
<p>At the start of a connection, the whitelister <strong>monitors the first two packets</strong> from the client. If <em>either</em> of those two packets matches a protocol fingerprint, the flow is unharmed; if no packet does, the second packet and rest of the flow from the client is blackholed (all packets in the flow are dropped). The whitelister will continue to drop the offending flow&rsquo;s network traffic for 60 seconds, but each time an additional packet is sent in a flow, this 60 second timer resets. This means that in practice, because TCP will retransmit packets that are not acknowledged, an offending flow will be affected by the whitelister for much longer than 60 seconds.</p>
<figure class="ph6-l">
    <img src="/iran-whitelister-darkmode2.svg"/> 
</figure>

<p>The system works in tandem with Iran&rsquo;s standard censorship system: the protocol whitelister ensures communication only occurs over certain protocols that the regular censorship system can verify.</p>
<h2 id="how-to-trigger-the-whitelister">How to Trigger the Whitelister</h2>
<p>To trigger the whitelister, one can open port 53, 80, or 443 on a machine outside of Iran (<code>nc -lvp 80</code>) and then connect to it from inside of Iran (<code>nc &lt;ip&gt; 80</code>). Sending a simple message twice  (<code>test&lt;Enter&gt;test</code>) is sufficient to trigger the whitelisterâ€”if the whitelister is running and affects the destination IP, only the first message will reach the server.</p>
<p>Like Iran&rsquo;s regular censorship systems, the whitelister does not check checksums and is incapable of reassembling TCP segments.</p>
<h2 id="how-clients-and-servers-are-affected">How Clients and Servers are Affected</h2>
<p><strong>The whitelister is not bidirectional.</strong> This means that it only affects connections where the client is inside Iran, making it more challenging for researchers to probe and study from outside the country.</p>
<p>The server receives almost no indication censorship has taken place. Unlike with the Great Firewall which sends RSTs in both directions, once the whitelister steps in to censor the traffic flow, it only affects the packets leaving the client: packets from the server are unharmed. <strong>Although the client will still get the server&rsquo;s data, the client is unable to ACK or respond to any data.</strong></p>
<hr>
<h1 id="measuring-the-protocol-whitelister">Measuring the Protocol Whitelister</h1>
<p>These properties make it challenging to even <em>detect</em> the whitelister from outside of Iran.  Here, we describe additional experiments we performed to learn who the whitelister affects, what its fingerprints are, and how to circumvent it altogether.</p>
<h2 id="affected-ip-space">Affected IP Space</h2>
<p>In order to identify which IPs are affected by the whitelister, we performed an experiment to test the effects of the whitelister on the Alexa top 20,000 list. To avoid the effects of DNS censorship or  requesting IPs inside of Iran (thereby not crossing the whitelister), we used <code>dig</code> outside of Iran to get IP addresses for all 20,000.</p>
<p>Inside of Iran, we set up an experiment with two conditions. The first condition was a control: we made normal <code>GET</code> requests to all 20,000 IP addresses using a python socket, and the success or failure of the request was recorded. The second condition tested for the whitelister. We requested all 20,000 IP addresses again, this time sending <code>G</code>, <code>ET</code> and <code>/</code> in separate messages.</p>
<p>IP addresses that respond in the first condition but time out in the second condition are likely affected by the whitelister. We perform this experiment ten times to validate the results.</p>
<p>Over all 10 experiments, 3595 IPs (15.09%) came up as affected at least 8 times. Of those, 3499 came up as affected all ten times (14.77%). 278 (1.17%) IPs came up as affected between 3 and 7 times, inclusive.</p>
<h3 id="why-are-only-certain-ips-affected">Why are only certain IPs affected?</h3>
<p>We explored whether the provider for an IP address was correlated with whether the whitelister affected it. Using whois lookups, we extracted the providers for affected and unaffected IPs.</p>
<div class ="flex-container" style='align-items: start'>
  
<div class="flex-column">
  
<div class="rightjustifysecondcolumn">
    
<p>Top 10 providers for affected IP addresses</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Count</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Amazon Technologies Inc.</td>
<td>1453</td>
<td></td>
</tr>
<tr>
<td>Cloudflare, Inc.</td>
<td>565</td>
<td></td>
</tr>
<tr>
<td>Akamai Technologies, Inc.</td>
<td>229</td>
<td></td>
</tr>
<tr>
<td>Amazon.com, Inc.</td>
<td>171</td>
<td></td>
</tr>
<tr>
<td>Fastly</td>
<td>167</td>
<td></td>
</tr>
<tr>
<td>DigitalOcean, LLC</td>
<td>146</td>
<td></td>
</tr>
<tr>
<td>Amazon Data Services Limited</td>
<td>97</td>
<td></td>
</tr>
<tr>
<td>RIPE Network Coordination Centre</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>Linode</td>
<td>64</td>
<td></td>
</tr>
<tr>
<td>Amazon Data Services</td>
<td>60</td>
<td></td>
</tr>
</tbody>
</table>



</div>


</div>


<div class="flex-column">
  
<div class="rightjustifysecondcolumn">
    
<p>Top 10 providers for unaffected IP addresses</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Count</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Cloudflare, Inc.</td>
<td>4541</td>
<td></td>
</tr>
<tr>
<td><em>Unknown</em></td>
<td>1465</td>
<td></td>
</tr>
<tr>
<td>Google LLC</td>
<td>657</td>
<td></td>
</tr>
<tr>
<td>ALISOFT</td>
<td>657</td>
<td></td>
</tr>
<tr>
<td>Amazon Technologies Inc.</td>
<td>580</td>
<td></td>
</tr>
<tr>
<td>Asia Pacific NIC</td>
<td>544</td>
<td></td>
</tr>
<tr>
<td>RIPE Network Coordination Centre</td>
<td>537</td>
<td></td>
</tr>
<tr>
<td>Alibaba.com LLC</td>
<td>287</td>
<td></td>
</tr>
<tr>
<td>Amazon.com, Inc.</td>
<td>277</td>
<td></td>
</tr>
<tr>
<td>Akamai Technologies, Inc.</td>
<td>253</td>
<td></td>
</tr>
</tbody>
</table>



</div>


</div>


</div>

<p>Overall, IP provider does not seem to be correlated with whether the whitelister affects an IP address.</p>
<h3 id="case-study-cloudflare">Case Study: Cloudflare</h3>
<p>As Cloudflare appears on both lists, we next explored how much of its infrastructure was affected by the whitelister. Cloudflare&rsquo;s IP prefixes are available publicly on their <a href="https://www.cloudflare.com/ips/">website</a>. As many of these prefixes are prohibitively large, instead of testing every IP in each prefix, we sampled 256 IP addresses at random for each prefix to test.</p>
<p>We performed a similar experiment to the above: given a Cloudflare IP address, we make two requests to it (first normally, second segmented); IP addresses that respond in the first condition but time out in the second condition are likely affected by the whitelister.  We repeated this experiment 5 times for each prefix.</p>
<p>We found that only 2 of Cloudflare&rsquo;s prefixes contained IPs that were affected by the whitelister: <code>104.18.0.0/16</code> and <code>104.31.82.0/24</code>. Both these entire prefixes appear affected, but none of the other prefixes on Cloudflare&rsquo;s website contained IP addresses in our experiments that appeared affected by the whitelister.</p>
<h3 id="summary">Summary</h3>
<p>Frankly, it is not clear why the whitelister affects the IP addresses it does. Anecdotally, all of our vantage points in Amazon EC2 and DigitalOcean around the world were affected by the whitelister, but our Alexa experiment suggests that not all IP addresses managed by Amazon or DigitalOcean are affected. Which IPs are affected may be an artifact of the varied network routes taken from our vantage points, or that Iran selected specific regions of the IPv4 address space as more important to filter.  We leave a further investigation into why the whitelister affects what it does to future work.</p>
<hr>
<h1 id="fingerprints">Fingerprints</h1>
<p>We reverse engineered the whitelister&rsquo;s fingerprints for each protocol. Knowing these fingerprints can be a powerful tool for evaders: by injecting a fingerprint at the start of a connection, the whitelister can be bypassed. Since the whitelister will match any of these fingerprints on all three ports, any fingerprint can be used on any whitelisted ports.</p>
<h3 id="dns-fingerprint">DNS Fingerprint</h3>
<p>The DNS protocol matcher seems to OK flows if the following conditions are met:</p>
<ul>
<li>TCP payload must be â‰¥ 12 bytes</li>
<li>Structure of the TCP payload must be a valid DNS-over-UDP header, not a DNS-over-TCP header. Recall that the whitelister is <em>only active</em> over TCP - this means their whitelister will <em>never match a legitimate DNS-over-TCP packet.</em> The reason this has not caused a significant issue is because the whitelister only affects data from the client <em>after</em> the first packet, and there is no second packet from the client in a traditional DNS-over-TCP connection.</li>
<li>Specific limitations exist for the fields within the DNS header: QR must be 0, QDcount must be less than 15, and ANcount must be 0.</li>
</ul>
<p>Example: <code>\x00\x00\x01\x00\x00\x01\x00\x00\x00\x00\x00\x00</code></p>
<h3 id="http-fingerprint">HTTP Fingerprint</h3>
<p>The HTTP protocol matcher seems to OK flows if the following conditions are met:</p>
<ul>
<li>The TCP payload must be â‰¥ 8 bytes</li>
<li>The payload must start with a specific HTTP verb followed by one space; e.g. <code>&quot;GET &quot;</code>  or <code>&quot;POST &quot;</code></li>
<li>The whitelister can match GET, POST, HEAD, CONNECT, OPTIONS, DELETE, and PUT. TRACE and PATCH do not work.</li>
</ul>
<p>Example: <code>GET testing123</code></p>
<h3 id="https-fingerprint">HTTPS Fingerprint</h3>
<p>The HTTPS protocol matcher seems to OK the flow if the following conditions are met:</p>
<ul>
<li>The TCP payload must be â‰¥ 41 bytes: 5 bytes for the TLS header, 36 for the TLS Client Hello</li>
<li>The length field of the TLS Header equals the length of the Client Hello</li>
<li>The TLS version header (bytes 2 and 3 of the TCP payload) is TLS 1.0, 1.1, or 1.2,  (<code>\x03\x01</code>, <code>\x03\x02</code>, <code>\x03\x03</code>, respectively). Note that real TLS 1.x Client Hellos all have TLS 1.0 in this field, so this criterion has no practical difference.</li>
</ul>
<p>After the first 5 bytes of the packet (the type, the version, and the length, 1, 2, and 2 bytes respectively), the whitelister does not look at any contents of the Client Hello. Writing garbage bytes to the remaining bytes of the Client Hello does not trip the whitelister.</p>
<p>Example TCP Payload: <code>\x16\x03\x01\x02\x00...</code>, where <code>\x16</code> is the indication of a handshake, <code>\x03\x01</code> is TLS version (1.0), and <code>\x02\x00</code> is the length of the Client Hello (512 bytes)</p>
<hr>
<h1 id="using-geneva-to-bypass-the-whitelister">Using Geneva to Bypass the Whitelister</h1>
<div class="callout callout-blue" style="">
  <div></div>
	<div class="callout-inner">
<p><strong>Geneva (<em>Gen</em>etic <em>Eva</em>sion)</strong> is a genetic algorithm we developed that <em>evolves</em> censorship evasion strategies against a censor. Unlike most anti-censorship systems, it does not require deployment at both ends of the connection: it runs exclusively at one side (client or server) and defeats censorship by manipulating the packet stream to confuse the censor without impacting the underlying connection. A <em>censorship evasion strategy</em> describes how that traffic should be modified. Since Geneva will be evolving these strategies, they are expressed in a domain-specific language that comprises the DNA of each strategy. (For a full rundown of Geneva&rsquo;s strategy DNA syntax, see <a href="https://github.com/kkevsterrr/geneva">our Github page</a>).</p>
<p>Geneva is comprised of two main components. First, the genetic algorithm, which can evolve new ways to defeat a censorship system given an application that experiences censorship and a fitness function. Second, the strategy engine, which applies a given strategy on the fly to modify active network traffic.</p>
  </div>
</div>
<p>We trained Geneva against the protocol whitelister. We wrote a custom fitness function for Geneva which connected to a vantage point outside of Iran and repeatedly send non-whitelisted messages. Using this fitness function, Geneva could test and train strategies directly against the whitelister. <em>In under two hours</em>, it discovered two simple strategies that defeat it (beyond simply injecting an innocuous HTTP request). In this section, we will explore these surprisingly simple strategies.</p>
<p>The Geneva strategy engine is open source on <a href="http://github.com/kkevsterrr/geneva">our Github</a>, so all of these strategies can be deployed and used by anyone. Since they operate at the TCP layer, they can be applied to any application: with Geneva running, even an unmodified web browser can become a simple censorship evasion tool. To learn more about how Geneva (or the Geneva strategy engine) works under the hood, see our <a href="/papers">papers</a> or <a href="/about">about</a> page.</p>
<p>Note that Geneva is <em>not</em> designed as a general purpose evasion tool, and does not provide any additional encryption, privacy, or protection. It is a beta research system and it is not optimized for speed. Use these strategies at your own risk.</p>
<h3 id="circumvention-strategy-1">Circumvention Strategy 1</h3>
<p>The first strategy works by simply sending two additional packets before the 3-way handshake: two empty packets with the <code>FIN</code> flag set.</p>
<p>In Geneva&rsquo;s strategy DNA syntax, this strategy looks like this:</p>
<p><code>[TCP:flags:S]-duplicate(tamper{TCP:flags:replace:F}(duplicate,),)-|</code></p>
<p>This triggers on all outbound TCP <code>SYN</code> packets and duplicates them; to the first duplicate, the TCP <code>flags</code> field is set to <code>FIN</code>, and a second copy of this packet is made. The second duplicate of the <code>SYN</code> is unchanged. All three packets are sent on the wire. When the packets arrive at the server, the server ignores the <code>FIN</code> packets, since they are not associated with any connection yet, but the whitelister processes them, causing it to ignore the rest of our connection. The <code>SYN</code> arrives as normal and our connection can start unchanged.</p>
<p>We do not understand why this strategy works, though we hypothesize the <code>FIN</code> packets tricks the whitelister into thinking it has already missed the relevant data packets, causing it to ignore the rest of the flow.</p>
<h3 id="circumvention-strategy-2">Circumvention Strategy 2</h3>
<p>The second strategy is stranger than the first. This strategy works by sending <em>nine copies</em> of the <code>ACK</code> packet during the 3-way handshake.</p>
<p>In Geneva&rsquo;s strategy DNA syntax, this strategy looks like this:</p>
<p><code>[TCP:flags:A]-duplicate(duplicate(duplicate,duplicate),duplicate(duplicate,duplicate(duplicate(duplicate,),)))-|</code></p>
<p>By sending nine ACKs during the 3-way handshake, the whitelister ignores the rest of our packets. We hypothesize this works because the whitelister has some internal limit on the number of packets it processes for a given flow, and by sending these 9 packets, we can exceed this total, causing the whitelister to ignore the rest of our connection.</p>
<h3 id="circumvention-strategy-3">Circumvention Strategy 3</h3>
<p>Beyond exploiting the whitelister&rsquo;s shortcomings at the TCP layer, we can also use Geneva&rsquo;s strategy engine to bypass the whitelister by simply injecting one of the protocol fingerprints into the start of the connection. Here is one such strategy that injects the HTTP fingerprint into the connection stream before each data packet in the connection:</p>
<p><code>[TCP:flags:PA]-duplicate(tamper{TCP:load:replace:GET%20testing123}(tamper{TCP:chksum:corrupt},),)-| \/</code></p>
<h3 id="using-a-geneva-strategy">Using a Geneva Strategy</h3>
<p>To deploy one of these strategies, we can use Geneva&rsquo;s strategy engine (open source on <a href="https://github.com/kkevsterrr/geneva">our Github page</a>) to apply these strategies to our network traffic. Since the engine captures network traffic on a specified port, any application sending data on that port will be affected by the strategy. For example, we can test that these strategies work by trying to trigger the whitelister with <code>nc</code> as above with the engine running in the background.</p>
<pre><code>$ STRATEGY=&quot;[TCP:flags:PA]-duplicate(tamper{TCP:load:replace:GET%20testing123}(tamper{TCP:chksum:corrupt},),)-| \/&quot;
$ sudo python3 engine.py --strategy &quot;$STRATEGY&quot; --server-port 80 --log info &amp;
$ nc &lt;ip&gt; 80
test
test
# connection is still successful
</code></pre>
<p>In this case, we used Geneva to defeat the whitelister for a simple netcat application. We can also use this to defeat whitelisting and run a VPN or similar system on port 80.</p>
<hr>
<h1 id="conclusion">Conclusion</h1>
<p>Much censorship evasion design today is couched in this idea of maximizing <em>collateral damage</em> for the censor. The idea is that if a censor wants to shut down an anti-censorship system or block a resource, we should make it as costly as possible for them to do so. Usually this is done by designing the system in such a way that it forces censors to block much more than they want to, causing collateral damage. For example, running bridges/proxies/VPNs on EC2 has been popular under the assumption that a censor would have to block all of AWS in order to shut them down, which would cause enormous collateral damage due to all the websites that are hosted on AWS.</p>
<p>The whitelister represents an attempt for Iran to sidestep some of this collateral damage. By only allowing content from specific protocols, they can shutdown or degrade most anti-censorship tools without negatively impacting regular websites or services.</p>
<p>Iran has had a greater capacity for censorship than they have exercised in the past, and these systems can pose a threat to existing deployments of censorship-evasion tools (VPNs, Tor, etc). Worse, the unidirectional and non-universal nature of the whitelister makes it more challenging for researchers outside of the country to identify and study. With tools like Geneva, we hope to shorten the response time for the censorship evasion community and alert tool developers how they can make their tools more resilient in the ever-changing censorship landscape.</p>
<hr>
<h1 id="citations">Citations</h1>
<p>[1] Protocol whitelisting was briefly described in 2013: <a href="https://censorbib.nymity.ch/pdf/Aryan2013a.pdf">https://censorbib.nymity.ch/pdf/Aryan2013a.pdf</a>, as a capability they turned off after the 2013 elections were over.</p>
<hr>
<p><strong>Update (3/21/2020):</strong> Since this post was written, we were informed the Shatel ISP in Iran has announced the right to restrict access to <strong>any ports or protocols</strong> without informing the network. Combined with the whitelisting system, this poses a potentially threat to anti-censorship tools if only whitelisted ports are available.</p>
<div style="text-align: center;">
    
<div style="display: inline-block; width: 350px">
    
<blockquote class="twitter-tweet"><p lang="fa" dir="rtl">Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ :<br>&quot; <a href="https://twitter.com/hashtag/%D8%B4%D8%A7%D8%AA%D9%84?src=hash&amp;ref_src=twsrc%5Etfw">#Ø´Ø§ØªÙ„</a> Ø¨Ù‡ ØµÙ„Ø§Ø­ Ø¯ÛŒØ¯ Ø®ÙˆØ¯ØŒ Ø¯Ø± Ø±Ø§Ø³ØªØ§ÛŒ Ø­ÙØ¸ Ø§Ù…Ù†ÛŒØª Ø´Ø¨Ú©Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±Ú© Ø¨Ù‡ Ù¾ÙˆØ±Øª ÛŒØ§ Ù¾Ø±ÙˆØªÚ©Ù„Ù‡Ø§ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…ÙˆØ§Ø±Ø¯ Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø´Ø±Ø­ Ø¬Ø¯ÙˆÙ„ Ø²ÛŒØ± Ø§Ø³Øª. &quot;<br>ÙˆÙ‚ØªÛŒ Ù…ÛŒÚ¯ÛŒÙ… ØªÙˆ Ø§ÛŒÙ† Ù…Ù…Ù„Ú©Øª Ø§ÛŒÙ†ØªØ±Ù†Øª Ù†ÛŒØ³Øª Ø§Ø² Ù‡Ù…ÛŒÙ† Ø¬Ø§Ù‡Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒØ´Ù‡.<a href="https://twitter.com/hashtag/adsl?src=hash&amp;ref_src=twsrc%5Etfw">#adsl</a> <a href="https://t.co/ddTY26326H">pic.twitter.com/ddTY26326H</a></p>&mdash; Matin (@matinrco) <a href="https://twitter.com/matinrco/status/1240246443895652352?ref_src=twsrc%5Etfw">March 18, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


</div>


</div>

<p><strong>Update 3/22/2020):</strong> @narimangharib noted that Shatel have been doing this since 2018.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

        </main>
        <footer class="surface3 bottom-0 w-100 pa3" role="contentinfo">
    <div class="flex justify-between">
        <span class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3">
            <a class='no-underline' href="https://geneva.cs.umd.edu" >
                &copy;  censorship.ai 2023, proud member of <a href='https://breakerspace.io'>Breakerspace</a>
        </span>
        








<a href="https://github.com/kkevsterrr/geneva" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l" title="Github link" rel="noopener" aria-label="follow on Githubâ€”â€”Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






</div>
    </div>
</footer>

        

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


    </body>
</html>
